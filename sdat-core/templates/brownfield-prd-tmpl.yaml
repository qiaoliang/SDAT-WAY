template:
    id: brownfield-prd-template-v2
    name: 已有项目增强 PRD
    version: 2.0
    output:
        format: markdown
        filename: docs/prd.md
        title: "{{project_name}} 已有项目增强 PRD"

workflow:
    mode: interactive
    elicitation: advanced-elicitation

sections:
    - id: intro-analysis
      title: 项目分析和上下文
      instruction: |
          **重要 - 范围评估是必需的:**

          这个 PRD 是用于对现有项目进行重大增强，需要全面规划和多个故事。在继续之前：

          1. **评估增强复杂性**: 如果这是一个简单的功能添加或错误修复，可以在 1-2 次集中开发会话中完成，停止并建议："对于简单的更改，考虑使用 brownfield-create-epic 或 brownfield-create-story 任务与产品负责人代替。这个完整的 PRD 流程设计用于需要架构规划和多个协调故事的重大增强。"

          2. **项目上下文**: 确定我们是否在一个已经加载了项目的 IDE 中工作，或者用户是否需要提供项目信息。如果项目文件可用，分析 docs 文件夹中的现有文档。如果文档不足，建议先运行 document-project 任务。

          3. **深入评估要求**: 在做出任何建议之前，您必须彻底分析现有项目结构、模式和约束。每个建议必须基于实际项目分析，而不是假设。

          收集关于现有项目的全面信息。在继续之前，必须完成此部分。

          **重要**: 在整个分析过程中，明确与用户确认您的理解。对于您对现有项目的每个假设，问："基于我的分析，我理解 [假设]。这是正确的吗？"

          在用户验证您对现有系统的理解之前，不要进行任何建议。
      sections:
          - id: existing-project-overview
            title: 现有项目概览
            instruction: 检查 document-project 分析是否已经完成。如果是，引用该输出而不是重新分析。
            sections:
                - id: analysis-source
                  title: 分析来源
                  instruction: |
                      指示以下内容之一：
                      - Document-project 输出可用 at: {{path}}
                      - IDE 基于的最新分析
                      - 用户提供的信息
                - id: current-state
                  title: 当前项目状态
                  instruction: |
                      - 如果 document-project 输出存在: 从 "高级别架构" 和 "技术摘要" 部分提取摘要
                      - 否则: 简要描述项目当前的功能和主要目的
          - id: documentation-analysis
            title: 可用文档分析
            instruction: |
                If document-project was run:
                - 注意: "document-project 分析可用 - 使用现有技术文档"
                - 列出 document-project 创建的关键文档
                - 跳过下面的缺失文档检查
                - 否则, 检查现有文档。
            sections:
                - id: available-docs
                  title: Available Documentation
                  type: checklist
                  items:
                      - Tech Stack Documentation
                      - Source Tree/Architecture
                      - Coding Standards
                      - API Documentation
                      - External API Documentation
                      - UX/UI Guidelines
                      - Technical Debt Documentation
                      - "Other: {{other_docs}}"
                  instruction: |
                      - 如果 document-project 已经运行: "使用 document-project 输出的现有项目分析。"
                      - 如果关键文档缺失且没有 document-project: "我建议先运行 document-project 任务..."
                      - 如果 document-project 在 `Tech Stack Documentation` 上成功，则标记为 `✓`
                      - 如果 document-project 在 `Source Tree/Architecture` 上成功，则标记为 `✓`
                      - 如果 document-project 在 `Coding Standards` 上成功，则标记为 `✓`
                      - 如果 document-project 在 `API Documentation` 上成功，则标记为 `✓`
                      - 如果 document-project 在 `External API Documentation` 上成功，则标记为 `✓`
                      - 如果 document-project 在 `UX/UI Guidelines` 上成功，则标记为 `✓`
                      - 如果 document-project 在 `Technical Debt Documentation` 成功，则标记为 `✓`

          - id: enhancement-scope
            title: 增强范围定义
            instruction: 与用户明确定义这种增强的类型。这对于范围和方法至关重要。
            sections:
                - id: enhancement-type
                  title: 增强类型
                  type: checklist
                  instruction: 与用户确定哪种适用
                  items:
                      - 新功能添加
                      - 主要功能修改
                      - 与新系统的集成
                      - 性能/可扩展性改进
                      - UI/UX 重构
                      - 技术栈升级
                      - 错误修复和稳定性改进
                      - "其他: {{other_type}}"
                - id: enhancement-description
                  title: 增强描述
                  instruction: 2-3 句话描述用户想要添加或更改的内容
                - id: impact-assessment
                  title: 影响评估
                  type: checklist
                  instruction: 评估对现有代码库的影响范围
                  items:
                      - 最小影响 (孤立的添加)
                      - 中等影响 (一些现有代码更改)
                      - 重大影响 (重大的现有代码更改)
                      - 重大影响 (需要架构更改)
          - id: goals-context
            title: 目标和背景上下文
            sections:
                - id: goals
                  title: 目标
                  type: bullet-list
                  instruction: 1-line 目标列表，如果成功，此增强将交付
                - id: background
                  title: 背景上下文
                  type: paragraphs
                  instruction: 1-2 短段落解释为什么需要此增强，解决什么问题，以及如何与现有项目配合
          - id: changelog
            title: 变更日志
            type: table
            columns: [变更, 日期, 版本, 描述, 作者]

    - id: requirements
      title: 总体需求
      instruction: |
          根据您对现有项目的验证理解，起草功能和非功能需求。在提出需求之前，确认："这些需求基于我对您的现有系统的理解。请仔细审查并确认它们符合您的项目现实。"
      elicit: true
      sections:
          - id: functional
            title: 功能需求列表
            type: numbered-list
            prefix: FR
            instruction: 每个需求将是一个带有 FR 标识的子弹 markdown
            examples:
                - "FR1: 现有的待办事项列表将与新的 AI 重复检测服务集成，而不会破坏当前功能。"
          - id: non-functional
            title: 非功能需求列表
            type: numbered-list
            prefix: NFR
            instruction: 每个需求将是一个带有 NFR 标识的子弹 markdown，包括来自现有系统的约束
            examples:
                - "NFR1: 增强必须保持现有性能特征，并且不能超过当前内存使用量的 20%。"
          - id: compatibility
            title: 兼容性需求
            instruction: 对于 brownfield 至关重要 - 必须保持兼容性
            type: numbered-list
            prefix: CR
            template: "{{requirement}}: {{description}}"
            items:
                - id: cr1
                  template: "CR1: {{existing_api_compatibility}}"
                - id: cr2
                  template: "CR2: {{database_schema_compatibility}}"
                - id: cr3
                  template: "CR3: {{ui_ux_consistency}}"
                - id: cr4
                  template: "CR4: {{integration_compatibility}}"

    - id: ui-enhancement-goals
      title: 用户界面增强目标
      condition: 增强包括 UI 更改
      instruction: 对于 UI 更改，捕获它们如何与现有 UI 模式和设计系统集成
      sections:
          - id: existing-ui-integration
            title: 与现有 UI 的集成
            instruction: 描述新 UI 元素如何适应现有设计模式、风格指南和组件库
          - id: modified-screens
            title: 修改/新屏幕和视图
            instruction: 仅列出将修改或添加的屏幕/视图
          - id: ui-consistency
            title: UI 一致性要求
            instruction: 与现有应用程序保持视觉和交互一致的特定要求

    - id: technical-constraints
      title: 技术约束和集成要求
      instruction: 此部分取代了单独的架构文档。从现有项目分析中收集详细的技术约束。
      sections:
          - id: existing-tech-stack
            title: 现有技术栈
            instruction: |
                如果 document-project 输出可用，则:
                - 从 "实际技术栈" 表中提取
                - 包括版本号和任何注释的约束

                否则, 记录当前技术栈:
            template: |
                **语言**: {{languages}}
                **框架**: {{frameworks}}
                **数据库**: {{database}}
                **基础设施**: {{infrastructure}}
                **外部依赖**: {{external_dependencies}}
          - id: integration-approach
            title: 集成方法
            instruction: 定义增强如何与现有架构集成
            template: |
                **数据库集成策略**: {{database_integration}}
                **API 集成策略**: {{api_integration}}
                **前端集成策略**: {{frontend_integration}}
                **测试集成策略**: {{testing_integration}}
          - id: code-organization
            title: 代码组织和标准
            instruction: 基于现有项目分析，定义新代码如何适应现有模式
            template: |
                **文件结构方法**: {{file_structure}}
                **命名约定**: {{naming_conventions}}
                **编码标准**: {{coding_standards}}
                **文档标准**: {{documentation_standards}}
          - id: deployment-operations
            title: 部署和操作
            instruction: 增强如何适应现有部署管道
            template: |
                **构建过程集成**: {{build_integration}}
                **部署策略**: {{deployment_strategy}}
                **监控和日志**: {{monitoring_logging}}
                **配置管理**: {{config_management}}
          - id: risk-assessment
            title: 风险评估和缓解
            instruction: |
                If document-project output available:
                - 参考 "技术债务和已知问题" 部分
                - 包括 "解决方法和注意事项" 可能会影响增强
                - 注意任何从 "关键技术债务" 中识别的约束

                构建风险评估，包括现有已知问题:
            template: |
                **技术风险**: {{technical_risks}}
                **集成风险**: {{integration_risks}}
                **部署风险**: {{deployment_risks}}
                **缓解策略**: {{mitigation_strategies}}

    - id: epic-structure
      title: Epic 和 Story 结构
      instruction: |
          对于 brownfield 项目，除非用户明确请求多个不相关的增强，否则优先使用一个综合的 epic。在呈现 epic 结构之前，确认："基于我对您的现有项目的分析，我相信这个增强应该被结构化为 [单个 epic/多个 epic] 因为 [基于实际项目分析的依据]。这符合您对所需工作的理解吗？"
      elicit: true
      sections:
          - id: epic-approach
            title: Epic 方法
            instruction: 解释 epic 结构的理由 - 通常是单个 epic，除非用户明确请求多个不相关的功能
            template: "**Epic Structure Decision**: {{epic_decision}} with rationale"

    - id: epic-details
      title: "Epic 1: {{enhancement_title}}"
      instruction: |
          综合 epic，在保持现有功能的同时交付 brownfield 增强

          CRITICAL STORY SEQUENCING FOR BROWNFIELD:
          - 故事必须确保现有功能保持完整
          - 每个故事应该包括验证现有功能仍然有效
          - 故事应该按顺序排列，以最小化对现有系统的风险
          - 包括每个故事的回滚考虑
          - 专注于增量集成，而不是大爆炸变化
          - 根据现有代码库上下文调整故事大小
          - 必须: 呈现完整的 story 序列并问: "这个 story 序列旨在最小化对您现有系统的风险。这个顺序是否合理，考虑到您的项目架构和约束？"
          - 故事必须按逻辑顺序排列，并明确识别依赖关系
          - 每个故事必须交付价值，同时保持系统完整性
      template: |
          **Epic Goal**: {{epic_goal}}

          **Integration Requirements**: {{integration_requirements}}
      sections:
          - id: story
            title: "Story 1.{{story_number}} {{story_title}}"
            repeatable: true
            template: |
                **作为**: {{user_type}}
                **我想要**: {{action}}
                **以便**: {{benefit}}
            sections:
                - id: acceptance-criteria
                  title: 接受标准
                  type: numbered-list
                  instruction: 定义包括新功能和现有系统完整性的标准
                  item_template: "{{criterion_number}}: {{criteria}}"
                - id: integration-verification
                  title: 集成验证
                  instruction: 特定的验证步骤，以确保现有功能保持完整
                  type: numbered-list
                  prefix: IV
                  items:
                      - template: "IV1: {{existing_functionality_verification}}"
                      - template: "IV2: {{integration_point_verification}}"
                      - template: "IV1: {{performance_impact_verification}}"
